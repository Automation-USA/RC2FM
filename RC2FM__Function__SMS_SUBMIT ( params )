#Name: RC2FM__Function__SMS_SUBMIT ( params ) History: Created by Automation USA - Julio Toledo Created: 4-30-2017 Last Modified: 6-1-2017 (added commenting, error handling/reporting, test for modern FileMaker version, cURL support) Purpose: Posts outgoing SMS requests against RC2FM's "sms.php" endpoint with all required authentication and payload parameters. Parameters: $$DirectNumber = sender's phone number (obtained from "RC2FM_Login" during session initiation) $$smsTo = destination phone number (E164 number as string) $$message = text message (string) $$extension = RingCentral user id (obtained from "RC2FM_Login" during session initiation) $$account = RingCentral account id (obtained from "RC2FM_Login" during session initiation) $$rc2fm_session_id = environment parameters (obtained from "RC2FM_Subscript_Build_Session_ID") RingCentral account credentials (except password): auth = contents of field "RC2FM_GLOBALS::RC_User_Name" extension = RC2FM_GLOBALS::RC_User_ExtNumber (optional) Important Notes: None
Allow User Abort [ Off ]
#Test for global variables
If [ IsEmpty ( $$smsTo ) or IsEmpty ( $$message ) ]
	Perform Script [ “RC2FM__Fail [Internal] ( param )”; Parameter: "An SMS parameter is missing" ]
	Exit Script [ Result: 958 ]
End If

#Filter out non E164 characters
Set Variable [ $$smsTo; Value:Filter ( $$smsTo ; "0123456789+" ) ]

#Test for live token
Perform Script [ “RC2FM__Check_Session_Status” ]
Set Variable [ $tokenStatus; Value:Get ( ScriptResult ) ]

#Process token test response
If [ $tokenStatus = 0 and not IsEmpty ( RC2FM_GLOBALS::RC_User_Name ) & not IsEmpty ( RC2FM_GLOBALS::RC_User_Password ) ]
	Perform Script [ “RC2FM__Login” ]
	If [ IsEmpty ( $$extension ) ]
		Perform Script [ “RC2FM__Fail [Internal] ( param )”; Parameter: "RingCentral user account and/or password not provided.¶¶RC2FM session not active." ]
		Exit Script [ Result: "No active session and no user credentials" ]
	End If
Else If [ $tokenStatus = 0 and IsEmpty ( RC2FM_GLOBALS::RC_User_Name ) or IsEmpty ( RC2FM_GLOBALS::RC_User_Password ) ]
	Perform Script [ “RC2FM__Fail [Internal] ( param )”; Parameter: "RingCentral user account and/or password not provided.¶¶RC2FM session not active." ]
	Exit Script [ Result: "No active session and no user credentials" ]
End If

#Proceed with SMS
Set Variable [ $$smsFrom; Value:$$DirectNumber //If ( $$admin = True or IsEmpty ( $$DirectNumber ); $$MainCompanyNumber ; $$DirectNumber ) //If ( IsEmpty ( $$DirectNumber) ; Settings::RC_Username ; $$DirectNumber ) ]

#Initialize session variables
Perform Script [ “RC2FM__Subscript_Build_Session_ID” ]

#Initialize API response global field
Set Field [ RC2FM_GLOBALS::API_Response__RC_Reply; "Loading..." ]

#Test for modern FileMaker version
Perform Script [ “Subscript__Validate_Client_Version_≥16” ]
Set Variable [ $isModern; Value:Get ( ScriptResult ) ]

#Use cURL method for FM version 16+
If [ $isModern ]
	Set Variable [ $url; Value:RC2FM_SETTINGS::RC2FM_BaseURL & "/api/v1.php" ]
	#Set cURL options
	Set Variable [ $cURL_options; Value:"-d action=sms&auth=" & Base64Encode ( RC2FM_GLOBALS::RC_User_Name ) & If ( not IsEmpty ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "&extension=" & Base64Encode ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "" ) & "&user_id=" & Base64Encode ( $$extension ) & "&account_id=" & Base64Encode ( $$account ) & $$rc2fm_session_id & "&from=" & Base64Encode ( $$smsFrom ) & "&to=" & Base64Encode ( $$smsTo ) & "&text=" ]
	#Remove line breaks
	Perform Script [ “Subscript__Remove_LineBreaks ( param )”; Parameter: $cURL_options ]
	#Append SMS message and POST
	Set Variable [ $cURL_options; Value:Get ( ScriptResult ) & ( Base64EncodeRFC ( 4648 ; $$message ) ) ]
	Insert from URL [ RC2FM_GLOBALS::API_Response__RC_Reply; $url; cURL options: $cURL_options ] [ Select; No dialog; Verify SSL Certificates ]
	#Clean up response
	Set Field [ RC2FM_GLOBALS::API_Response__RC_Reply; Substitute ( RC2FM_GLOBALS::API_Response__RC_Reply ; "\/" ; "/" ) ]
	Go to Field [ ] [ Select/perform ]
Else If [ PatternCount( Get ( ApplicationVersion ) ; "Web" ) //legacy PlatformWeb ]
	#Use Insert from URL method on WebDirect platform (all previous versions)
	Set Variable [ $url; Value:RC2FM_SETTINGS::RC2FM_BaseURL & "/api/v1.php?action=sms&auth=" & Base64Encode ( RC2FM_GLOBALS::RC_User_Name ) & If ( not IsEmpty ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "&extension=" & Base64Encode ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "" ) & "&user_id=" & Base64Encode ( $$extension ) & "&account_id=" & Base64Encode ( $$account ) & $$rc2fm_session_id & "&from=" & Base64Encode ( $$smsFrom ) & "&to=" & Base64Encode ( $$smsTo ) & "&text=" & ( Substitute ( Base64Encode ( $$message ); [Char ( "10" ); ""]; [Char ( "13" ); ""]; [Char ( "¶" ); ""] ) ) ]
	Insert from URL [ RC2FM_GLOBALS::API_Response__RC_Reply; $url ] [ Select; No dialog; Verify SSL Certificates ]
	Go to Field [ ] [ Select/perform ]
Else
	#Use AJAX form method in WebViewer (all previous FM versions)

	#Capture host IP for AJAX response
	Set Variable [ $FileHost; Value:Case ( Get ( HostIPAddress ) = "" ; "$"; // File is local Get ( HostIPAddress ) ) ]

	#Substitute variables in AJAX template
	Set Variable [ $url; Value:Let ( [ $html = Substitute ( RC2FM_SETTINGS::RC_HtmlAjaxTemplate; ["{{URL}}"; RC2FM_SETTINGS::RC2FM_BaseURL & "/api/v1.php?action=sms&auth=" & Base64Encode ( RC2FM_GLOBALS::RC_User_Name ) & If ( not IsEmpty ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "&extension=" & Base64Encode ( RC2FM_GLOBALS::RC_User_ExtNumber ) ; "" ) & "&user_id=" & Base64Encode ( $$extension ) & "&account_id=" & Base64Encode ( $$account ) & $$rc2fm_session_id ]; ["{{FORM_DATA}}"; "from=" & Base64Encode ( $$smsFrom ) & "&to=" & Base64Encode ( $$smsTo ) & "&text=" & ( Substitute ( Base64Encode ( $$message ); [Char ( "10" ); ""]; [Char ( "13" ); ""]; [Char ( "¶" ); ""] ) )]; ["{{FILE_HOST}}"; $FileHost]; ["{{FILE_NAME}}"; Get( FileName )] ) ]; "data:text/html," & $html ) ]

	#Submit to WebViewer
	Set Web Viewer [ Object Name: "ajax_web_viewer"; URL: $url ]
	Go to Field [ ] [ Select/perform ]
End If

#Clean up
Set Field [ RC2FM_GLOBALS::SMS_Input_Field; "" ]
Set Field [ RC2FM_GLOBALS::SMS_ToPhone; "" ]
Set Variable [ $$smsFrom; Value:"" ]
Set Variable [ $$smsTo; Value:"" ]
Set Variable [ $$message; Value:"" ]

